<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Memorama Hiragana</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #f7f0e4; }
    @keyframes shake {
      0%,100%{transform:translateX(0)}
      20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}
      60%{transform:translateX(-5px)}
      80%{transform:translateX(5px)}
    }
    .shaking { animation: shake 0.4s ease; }
    @keyframes fall {
      0%{transform:translateY(-20px) rotate(0deg);opacity:1}
      100%{transform:translateY(100vh) rotate(720deg);opacity:0}
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    /* ‚îÄ‚îÄ DATA ‚îÄ‚îÄ */
    const GROUPS = {
      vowels: { label:"Vocales", kana:"„ÅÇ„ÅÑ„ÅÜ„Åà„Åä", chars:[{h:"„ÅÇ",r:"a"},{h:"„ÅÑ",r:"i"},{h:"„ÅÜ",r:"u"},{h:"„Åà",r:"e"},{h:"„Åä",r:"o"}] },
      ka: { label:"K", kana:"„Åã„Åç„Åè„Åë„Åì", chars:[{h:"„Åã",r:"ka"},{h:"„Åç",r:"ki"},{h:"„Åè",r:"ku"},{h:"„Åë",r:"ke"},{h:"„Åì",r:"ko"}] },
      sa: { label:"S", kana:"„Åï„Åó„Åô„Åõ„Åù", chars:[{h:"„Åï",r:"sa"},{h:"„Åó",r:"shi"},{h:"„Åô",r:"su"},{h:"„Åõ",r:"se"},{h:"„Åù",r:"so"}] },
      ta: { label:"T", kana:"„Åü„Å°„Å§„Å¶„Å®", chars:[{h:"„Åü",r:"ta"},{h:"„Å°",r:"chi"},{h:"„Å§",r:"tsu"},{h:"„Å¶",r:"te"},{h:"„Å®",r:"to"}] },
      na: { label:"N", kana:"„Å™„Å´„Å¨„Å≠„ÅÆ", chars:[{h:"„Å™",r:"na"},{h:"„Å´",r:"ni"},{h:"„Å¨",r:"nu"},{h:"„Å≠",r:"ne"},{h:"„ÅÆ",r:"no"}] },
      ha: { label:"H", kana:"„ÅØ„Å≤„Åµ„Å∏„Åª", chars:[{h:"„ÅØ",r:"ha"},{h:"„Å≤",r:"hi"},{h:"„Åµ",r:"fu"},{h:"„Å∏",r:"he"},{h:"„Åª",r:"ho"}] },
      ma: { label:"M", kana:"„Åæ„Åø„ÇÄ„ÇÅ„ÇÇ", chars:[{h:"„Åæ",r:"ma"},{h:"„Åø",r:"mi"},{h:"„ÇÄ",r:"mu"},{h:"„ÇÅ",r:"me"},{h:"„ÇÇ",r:"mo"}] },
      ya: { label:"Y", kana:"„ÇÑ„ÇÜ„Çà", chars:[{h:"„ÇÑ",r:"ya"},{h:"„ÇÜ",r:"yu"},{h:"„Çà",r:"yo"}] },
      ra: { label:"R", kana:"„Çâ„Çä„Çã„Çå„Çç", chars:[{h:"„Çâ",r:"ra"},{h:"„Çä",r:"ri"},{h:"„Çã",r:"ru"},{h:"„Çå",r:"re"},{h:"„Çç",r:"ro"}] },
      wa: { label:"W / N", kana:"„Çè„Çí„Çì", chars:[{h:"„Çè",r:"wa"},{h:"„Çí",r:"wo"},{h:"„Çì",r:"n"}] },
    };

    const LEVELS = [
      { label:"Nivel 1", emoji:"üå±", desc:"Solo vocales",    groups:["vowels"] },
      { label:"Nivel 2", emoji:"üåø", desc:"Vocales + K",     groups:["vowels","ka"] },
      { label:"Nivel 3", emoji:"üå∏", desc:"+ S y T",         groups:["vowels","ka","sa","ta"] },
      { label:"Nivel 4", emoji:"üçÉ", desc:"+ N y H",         groups:["vowels","ka","sa","ta","na","ha"] },
      { label:"Nivel 5", emoji:"üéã", desc:"+ M, Y y R",      groups:["vowels","ka","sa","ta","na","ha","ma","ya","ra"] },
      { label:"Completo",emoji:"‚õ©Ô∏è", desc:"Todo el hiragana",groups:Object.keys(GROUPS) },
    ];

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function buildDeck(selectedGroups) {
      let chars = [];
      selectedGroups.forEach(g => { if(GROUPS[g]) chars = chars.concat(GROUPS[g].chars); });
      if (chars.length > 15) chars = shuffle(chars).slice(0,15);
      const cards = [];
      chars.forEach((c,i) => {
        cards.push({ id:`h-${i}`, pairId:i, type:"hiragana", h:c.h, r:c.r });
        cards.push({ id:`r-${i}`, pairId:i, type:"romaji",   h:c.h, r:c.r });
      });
      return shuffle(cards);
    }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    function MemoryCard({ card, isFlipped, isMatched, onClick, hintMode, noTransition, cardPx }) {
      const kanaSize   = cardPx ? `${Math.round(cardPx*0.36)}px` : "2.6rem";
      const romajiSize = cardPx ? `${Math.round(cardPx*0.19)}px` : "1.45rem";
      const hintSize   = cardPx ? `${Math.round(cardPx*0.11)}px` : "0.85rem";

      return (
        <div onClick={isMatched ? undefined : onClick}
          style={{ perspective:"600px", cursor:isMatched?"default":"pointer", userSelect:"none" }}>
          <div style={{
            position:"relative", width:"100%", paddingBottom:"120%",
            transformStyle:"preserve-3d",
            transition: noTransition ? "none" : "transform 0.45s cubic-bezier(0.4,0,0.2,1)",
            transform: (isFlipped||isMatched) ? "rotateY(180deg)" : "rotateY(0deg)",
            filter: isMatched ? "saturate(0.4) opacity(0.6)" : "none",
          }}>
            {/* Back */}
            <div style={{
              position:"absolute", inset:0, backfaceVisibility:"hidden",
              borderRadius:"12px",
              background:"linear-gradient(135deg,#c8a97e,#a07850)",
              border:"2px solid #8a6540",
              display:"flex", alignItems:"center", justifyContent:"center",
              boxShadow:"0 4px 14px rgba(0,0,0,0.25)",
            }}>
              <span style={{ fontSize: cardPx ? `${Math.round(cardPx*0.22)}px`:"1.8rem", opacity:0.6, color:"#f5ede0" }}>‚ú¶</span>
            </div>
            {/* Front */}
            <div style={{
              position:"absolute", inset:0, backfaceVisibility:"hidden",
              transform:"rotateY(180deg)", borderRadius:"12px",
              background: card.type==="hiragana"
                ? "linear-gradient(160deg,#fdf6e8,#f5e8c8)"
                : "linear-gradient(160deg,#e8f0fd,#c8d8f5)",
              border: card.type==="hiragana" ? "2px solid #c8a050" : "2px solid #6080c8",
              display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center",
              gap:"2px", padding:"6px", boxShadow:"0 4px 14px rgba(0,0,0,0.2)",
            }}>
              {card.type==="hiragana" ? (<>
                <span style={{ fontSize:kanaSize, lineHeight:1, color:"#3a2010", fontFamily:"'Noto Serif JP',serif" }}>{card.h}</span>
                {hintMode && <span style={{ fontSize:hintSize, color:"#9a7040", letterSpacing:"0.06em", fontFamily:"Georgia,serif", marginTop:"2px" }}>{card.r}</span>}
              </>) : (<>
                {hintMode && <span style={{ fontSize:hintSize, color:"#4060b0", letterSpacing:"0.06em", fontFamily:"'Noto Serif JP',serif", marginBottom:"2px" }}>{card.h}</span>}
                <span style={{ fontSize:romajiSize, lineHeight:1, color:"#102050", fontFamily:"Georgia,'Times New Roman',serif", fontWeight:"bold", letterSpacing:"0.04em" }}>{card.r}</span>
              </>)}
            </div>
          </div>
        </div>
      );
    }

    /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
    function App() {
      const [screen, setScreen]               = useState("config");
      const [selectedGroups, setSelectedGroups] = useState(["vowels"]);
      const [hintMode, setHintMode]           = useState(true);
      const [deck, setDeck]                   = useState([]);
      const [flipped, setFlipped]             = useState([]);
      const [matched, setMatched]             = useState(new Set());
      const [moves, setMoves]                 = useState(0);
      const [locked, setLocked]               = useState(false);
      const [shake, setShake]                 = useState(null);
      const [noTransition, setNoTransition]   = useState(new Set());
      const [activeLevel, setActiveLevel]     = useState(0);
      const timerRef = useRef(null);
      const gridRef  = useRef(null);
      const [cardPx, setCardPx]               = useState(null);

      const cols = deck.length <= 10 ? 4 : deck.length <= 16 ? 4 : 6;

      useEffect(() => {
        if (!gridRef.current) return;
        const measure = () => {
          const gridW = gridRef.current?.offsetWidth ?? 0;
          const w = (gridW - 10*(cols-1)) / cols;
          setCardPx(w > 0 ? w : null);
        };
        measure();
        const ro = new ResizeObserver(measure);
        ro.observe(gridRef.current);
        return () => ro.disconnect();
      }, [deck, cols]);

      const totalPairs = deck.length / 2;

      const startGame = useCallback(() => {
        if (selectedGroups.length === 0) return;
        const newDeck = buildDeck(selectedGroups);
        setDeck(newDeck);
        setFlipped([]);
        setMatched(new Set());
        setMoves(0);
        setLocked(false);
        setNoTransition(new Set());
        setScreen("game");
      }, [selectedGroups]);

      const handleFlip = (card) => {
        if (locked) return;
        if (flipped.includes(card.id)) return;
        if (matched.has(card.pairId)) return;

        const newFlipped = [...flipped, card.id];
        setFlipped(newFlipped);

        if (newFlipped.length === 2) {
          setMoves(m => m+1);
          setLocked(true);
          const [id1,id2] = newFlipped;
          const c1 = deck.find(c => c.id===id1);
          const c2 = deck.find(c => c.id===id2);

          if (c1.pairId===c2.pairId && c1.type!==c2.type) {
            const newMatched = new Set(matched);
            newMatched.add(c1.pairId);
            timerRef.current = setTimeout(() => {
              setMatched(newMatched);
              setFlipped([]);
              setLocked(false);
              if (newMatched.size === totalPairs) setTimeout(() => setScreen("win"), 300);
            }, 600);
          } else {
            timerRef.current = setTimeout(() => {
              setShake(id1);
              setTimeout(() => setShake(id2), 80);
              setTimeout(() => setShake(null), 500);
              setTimeout(() => setNoTransition(new Set([id1,id2])), 600);
              setTimeout(() => setFlipped([]), 620);
              setTimeout(() => { setNoTransition(new Set()); setLocked(false); }, 670);
            }, 400);
          }
        }
      };

      useEffect(() => () => clearTimeout(timerRef.current), []);

      const applyLevel = (i) => { setActiveLevel(i); setSelectedGroups([...LEVELS[i].groups]); };
      const toggleGroup = (key) => {
        setActiveLevel(null);
        setSelectedGroups(prev => prev.includes(key) ? prev.filter(g=>g!==key) : [...prev,key]);
      };

      /* ‚îÄ‚îÄ STYLES ‚îÄ‚îÄ */
      const paperBg = {
        minHeight:"100vh", background:"#f7f0e4",
        backgroundImage:`radial-gradient(circle at 20% 20%,rgba(200,160,100,0.08),transparent 50%),radial-gradient(circle at 80% 80%,rgba(160,130,80,0.06),transparent 50%)`,
        fontFamily:"Georgia,'Times New Roman',serif", position:"relative", overflow:"hidden",
      };
      const decorKanji = { position:"fixed", opacity:0.035, fontSize:"20rem", fontFamily:"'Noto Serif JP',serif", color:"#6a4820", pointerEvents:"none", lineHeight:1, userSelect:"none" };
      const btnPrimary = { background:"linear-gradient(135deg,#c8803a,#a06020)", color:"#fff", border:"none", borderRadius:"8px", padding:"12px 28px", fontSize:"1rem", cursor:"pointer", fontFamily:"Georgia,serif", letterSpacing:"0.05em", boxShadow:"0 4px 12px rgba(160,90,20,0.4)" };
      const btnSecondary = { background:"transparent", color:"#8a5020", border:"2px solid #c8a060", borderRadius:"8px", padding:"10px 22px", fontSize:"0.9rem", cursor:"pointer", fontFamily:"Georgia,serif", letterSpacing:"0.04em" };

      /* ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ */
      if (screen === "config") return (
        <div style={paperBg}>
          <span style={{...decorKanji, top:"-3rem", left:"-3rem"}}>„ÅÇ</span>
          <span style={{...decorKanji, bottom:"-5rem", right:"-3rem", fontSize:"16rem"}}>Â≠ó</span>
          <div style={{ maxWidth:"640px", margin:"0 auto", padding:"40px 20px" }}>

            <div style={{ textAlign:"center", marginBottom:"36px" }}>
              <div style={{ fontSize:"3rem", marginBottom:"8px" }}>‚õ©Ô∏è</div>
              <h1 style={{ fontSize:"2rem", color:"#3a2010", margin:"0 0 6px", letterSpacing:"0.05em" }}>Memorama Hiragana</h1>
              <p style={{ color:"#8a6040", margin:0, fontSize:"0.95rem" }}>Relaciona cada grafema con su lectura romaji</p>
            </div>

            <section style={{ marginBottom:"28px" }}>
              <h2 style={{ fontSize:"0.8rem", letterSpacing:"0.15em", textTransform:"uppercase", color:"#9a7050", margin:"0 0 12px" }}>Niveles predefinidos</h2>
              <div style={{ display:"grid", gridTemplateColumns:"repeat(3,1fr)", gap:"8px" }}>
                {LEVELS.map((lvl,i) => (
                  <button key={i} onClick={() => applyLevel(i)} style={{ padding:"10px 8px", borderRadius:"10px", border: activeLevel===i ? "2px solid #c8803a":"2px solid #d4b888", background: activeLevel===i ? "#fdf0d8":"#fff9f0", cursor:"pointer", boxShadow: activeLevel===i ? "0 2px 8px rgba(200,120,50,0.3)":"none" }}>
                    <div style={{ fontSize:"1.3rem" }}>{lvl.emoji}</div>
                    <div style={{ fontSize:"0.8rem", fontWeight:"bold", color:"#5a3820" }}>{lvl.label}</div>
                    <div style={{ fontSize:"0.65rem", color:"#9a7050" }}>{lvl.desc}</div>
                  </button>
                ))}
              </div>
            </section>

            <section style={{ marginBottom:"28px" }}>
              <h2 style={{ fontSize:"0.8rem", letterSpacing:"0.15em", textTransform:"uppercase", color:"#9a7050", margin:"0 0 12px" }}>O elige grupos manualmente</h2>
              <div style={{ display:"flex", flexWrap:"wrap", gap:"8px" }}>
                {Object.entries(GROUPS).map(([key,grp]) => {
                  const active = selectedGroups.includes(key);
                  return (
                    <button key={key} onClick={() => toggleGroup(key)} style={{ display:"flex", flexDirection:"column", alignItems:"center", padding:"8px 14px", borderRadius:"10px", border: active ? "2px solid #c8803a":"2px solid #d4b888", background: active ? "#fdf0d8":"#fff9f0", cursor:"pointer", minWidth:"62px" }}>
                      <span style={{ fontSize:"0.65rem", fontFamily:"'Noto Serif JP',serif", color:"#8a6040" }}>{grp.kana}</span>
                      <span style={{ fontSize:"0.85rem", fontWeight:"bold", color: active ? "#a05020":"#6a4828" }}>{grp.label}</span>
                    </button>
                  );
                })}
              </div>
              {selectedGroups.length===0 && <p style={{ color:"#c85030", fontSize:"0.8rem", margin:"8px 0 0" }}>‚ö†Ô∏è Selecciona al menos un grupo para jugar.</p>}
            </section>

            <section style={{ marginBottom:"36px" }}>
              <h2 style={{ fontSize:"0.8rem", letterSpacing:"0.15em", textTransform:"uppercase", color:"#9a7050", margin:"0 0 12px" }}>Modo ayuda</h2>
              <div onClick={() => setHintMode(!hintMode)} style={{ display:"flex", alignItems:"center", gap:"14px", padding:"14px 18px", borderRadius:"12px", border: hintMode ? "2px solid #c8803a":"2px solid #d4b888", background: hintMode ? "#fdf0d8":"#fff9f0", cursor:"pointer" }}>
                <div style={{ width:"44px", height:"24px", borderRadius:"12px", background: hintMode ? "#c8803a":"#c8b898", position:"relative", flexShrink:0, transition:"background 0.3s" }}>
                  <div style={{ position:"absolute", top:"3px", left: hintMode ? "23px":"3px", width:"18px", height:"18px", borderRadius:"50%", background:"#fff", transition:"left 0.3s", boxShadow:"0 1px 3px rgba(0,0,0,0.3)" }} />
                </div>
                <div>
                  <div style={{ fontSize:"0.9rem", fontWeight:"bold", color:"#3a2010" }}>Mostrar pista en la tarjeta</div>
                  <div style={{ fontSize:"0.75rem", color:"#8a6040" }}>Las tarjetas de hiragana muestran el romaji peque√±o debajo, y viceversa</div>
                </div>
              </div>
            </section>

            <div style={{ textAlign:"center" }}>
              <button onClick={startGame} disabled={selectedGroups.length===0} style={{ ...btnPrimary, opacity: selectedGroups.length===0 ? 0.5:1, fontSize:"1.1rem", padding:"14px 48px" }}>
                ¬°Comenzar!
              </button>
            </div>
          </div>
        </div>
      );

      /* ‚îÄ‚îÄ WIN ‚îÄ‚îÄ */
      if (screen === "win") return (
        <div style={{ ...paperBg, display:"flex", alignItems:"center", justifyContent:"center" }}>
          {Array.from({length:18}).map((_,i) => (
            <div key={i} style={{ position:"fixed", top:0, left:`${5+i*5.5}%`, fontSize:"1.5rem", animation:`fall ${2+(i%4)*0.6}s ${i*0.2}s ease-in infinite`, pointerEvents:"none" }}>
              {["üå∏","‚úø","‚ãÜ","‚ú¶","Ëä±"][i%5]}
            </div>
          ))}
          <div style={{ background:"rgba(255,250,240,0.95)", borderRadius:"20px", border:"2px solid #c8a060", padding:"48px 56px", textAlign:"center", boxShadow:"0 20px 60px rgba(100,60,20,0.3)", maxWidth:"420px", width:"90%" }}>
            <div style={{ fontSize:"4rem", marginBottom:"12px" }}>üéâ</div>
            <h1 style={{ fontSize:"2rem", color:"#3a2010", margin:"0 0 8px", fontFamily:"'Noto Serif JP',serif" }}>¬°Completado!</h1>
            <p style={{ color:"#8a6040", margin:"0 0 24px", fontSize:"1rem" }}>
              Emparejaste {totalPairs} pares en <strong style={{ color:"#c8603a" }}>{moves} movimientos</strong>
            </p>
            <div style={{ display:"flex", gap:"12px", justifyContent:"center" }}>
              <button onClick={startGame} style={btnPrimary}>Otra vez üîÑ</button>
              <button onClick={() => setScreen("config")} style={btnSecondary}>Configurar</button>
            </div>
          </div>
        </div>
      );

      /* ‚îÄ‚îÄ GAME ‚îÄ‚îÄ */
      return (
        <div style={paperBg}>
          {/* Top bar */}
          <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", padding:"14px 20px", background:"rgba(255,250,240,0.9)", borderBottom:"1px solid #d4b888", position:"sticky", top:0, zIndex:10 }}>
            <button onClick={() => setScreen("config")} style={{ ...btnSecondary, padding:"6px 14px", fontSize:"0.8rem" }}>‚Üê Config</button>
            <div style={{ textAlign:"center" }}>
              <div style={{ fontSize:"0.7rem", letterSpacing:"0.12em", textTransform:"uppercase", color:"#9a7050" }}>Movimientos</div>
              <div style={{ fontSize:"1.4rem", fontWeight:"bold", color:"#3a2010", lineHeight:1 }}>{moves}</div>
            </div>
            <div style={{ textAlign:"center" }}>
              <div style={{ fontSize:"0.7rem", letterSpacing:"0.12em", textTransform:"uppercase", color:"#9a7050" }}>Parejas</div>
              <div style={{ fontSize:"1.4rem", fontWeight:"bold", color:"#3a2010", lineHeight:1 }}>
                {matched.size}<span style={{ color:"#c8a060", fontSize:"0.9rem" }}>/{totalPairs}</span>
              </div>
            </div>
            <div style={{ display:"flex", alignItems:"center", gap:"8px" }}>
              <span style={{ fontSize:"0.75rem", color:"#8a6040" }}>Pistas</span>
              <div onClick={() => setHintMode(!hintMode)} style={{ width:"38px", height:"20px", borderRadius:"10px", background: hintMode ? "#c8803a":"#c8b898", position:"relative", cursor:"pointer", transition:"background 0.3s" }}>
                <div style={{ position:"absolute", top:"2px", left: hintMode ? "20px":"2px", width:"16px", height:"16px", borderRadius:"50%", background:"#fff", transition:"left 0.3s", boxShadow:"0 1px 3px rgba(0,0,0,0.25)" }} />
              </div>
            </div>
            <button onClick={startGame} style={{ ...btnSecondary, padding:"6px 14px", fontSize:"0.8rem" }}>üîÑ</button>
          </div>

          {hintMode && (
            <div style={{ display:"flex", justifyContent:"center", gap:"20px", padding:"8px 0 4px", fontSize:"0.72rem", color:"#9a7050" }}>
              <span>üü° Hiragana grande ¬∑ romaji peque√±o</span>
              <span>üîµ Romaji grande ¬∑ hiragana peque√±o</span>
            </div>
          )}

          <div ref={gridRef} style={{ display:"grid", gridTemplateColumns:`repeat(${cols},1fr)`, gap:"10px", padding:"16px 16px 32px", maxWidth:"680px", margin:"0 auto" }}>
            {deck.map(card => (
              <div key={card.id} className={shake===card.id ? "shaking" : ""}>
                <MemoryCard
                  card={card}
                  isFlipped={flipped.includes(card.id)}
                  isMatched={matched.has(card.pairId)}
                  onClick={() => handleFlip(card)}
                  hintMode={hintMode}
                  noTransition={noTransition.has(card.id)}
                  cardPx={cardPx}
                />
              </div>
            ))}
          </div>

          <div style={{ position:"fixed", bottom:0, left:0, right:0, height:"4px", background:"#e8d8b8" }}>
            <div style={{ height:"100%", background:"linear-gradient(90deg,#c8803a,#e8b060)", width: totalPairs>0 ? `${(matched.size/totalPairs)*100}%`:"0%", transition:"width 0.5s ease" }} />
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
